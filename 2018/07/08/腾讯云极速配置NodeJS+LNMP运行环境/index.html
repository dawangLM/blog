<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 腾讯云极速配置NodeJS+LNMP运行环境 · 信鑫-King's Blog</title><meta name="description" content="腾讯云极速配置NodeJS+LNMP运行环境 - Kylin King"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://www.ycjcl.cc/atom.xml" title="信鑫-King's Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/ycjcl868" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/ycjcl868" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">腾讯云极速配置NodeJS+LNMP运行环境</h1><div class="post-info">Jul 8, 2018</div><div class="post-content"><blockquote>
<p>需求： 之前使用 <code>PHP+Mysql</code> 做开发，近年来<code>NodeJS</code>有点火，且不需要<code>Apache</code>、<code>Nginx</code>、<code>Tomcat</code>做容器，想在不影响之前<code>PHP</code>开发环境下，也能体验<code>NodeJS+Mysql</code>玩法。国内搜索了很多也没有发现有关<code>LNMP+Nodejs</code>的具体部署教程，于是踩了很多坑，终于配出了<strong>NodeJS+LNMP+PHPMyAdmin</strong></p>
</blockquote>
<h2 id="一、购买服务器"><a href="#一、购买服务器" class="headerlink" title="一、购买服务器"></a>一、购买服务器</h2><h4 id="1-选择服务器配置"><a href="#1-选择服务器配置" class="headerlink" title="1.选择服务器配置"></a>1.选择服务器配置</h4><p>因为NodeJS<strong>异步</strong>、<strong>非阻塞</strong>的特性，所以<strong>多核CPU</strong>对NodeJS算比较浪费吧，所以主要提高内存的大小，所以选了<strong>腾讯云1核、2G 内存</strong>的服务器。</p>
<p><img src="http://7xi72v.com1.z0.glb.clouddn.com/16-11-4/55884377.jpg" alt=""></p>
<h4 id="2-选择镜像"><a href="#2-选择镜像" class="headerlink" title="2.选择镜像"></a>2.选择镜像</h4><blockquote>
<p>这个比较重要，镜像要是选得好，配置起来各种高效率。这里我推荐的系统是<strong>CentOS 7+</strong>  (主要是因为CentOS 6使用的是Python 2.6，<strong>yum</strong>各种坑，想升级成Python 2.7坑还多)。</p>
</blockquote>
<p>镜像选择 <strong>PHP运行环境（CentOS7.1 64位 Nginx | PHP多版本）</strong>，<strong>腾讯云</strong>里的服务提供商<strong>上海微柳</strong>这家提供的<code>oneinstack</code> 太强大了，工具和文档都很详细，并且和其它的镜像不一样的是，<code>ssh</code>连接时，会有暗红高亮，相当好用。然后直接买、买、买就行了（较其它主机提供商，腾讯云的学生机相当给力）。</p>
<p><img src="http://7xi72v.com1.z0.glb.clouddn.com/16-11-4/19776864.jpg" alt=""></p>
<p>然后就配好了，访问服务器80端口，下载镜像的文档(超级方便的各种脚本)：</p>
<p><img src="http://7xi72v.com1.z0.glb.clouddn.com/16-11-4/80203594.jpg" alt=""></p>
<h2 id="二、基本配置"><a href="#二、基本配置" class="headerlink" title="二、基本配置"></a>二、基本配置</h2><blockquote>
<p>注意：有些服务器需要在腾讯云的控制台上设置安全组，不然22端口将无法开放，就会导致才买的服务器通过<code>ssh</code>连不上。</p>
</blockquote>
<p><img src="http://7xi72v.com1.z0.glb.clouddn.com/17-2-15/53347020-file_1487151858921_15c5a.png" alt=""></p>
<p>首先开启FTP，方便传文件：</p>
<h4 id="1-开启FTP服务器"><a href="#1-开启FTP服务器" class="headerlink" title="1.开启FTP服务器"></a>1.开启FTP服务器</h4><p><code>service pureftpd start</code>开启，这样就可以配置FTP了。  首先进入<code>oneinstack</code>目录 -&gt; 运行<code>./pureftpd_vhost.sh</code> -&gt; 添加一个FTP用户</p>
<p><img src="http://7xi72v.com1.z0.glb.clouddn.com/16-11-4/72972548.jpg" alt=""></p>
<h4 id="2-更改Mysql密码"><a href="#2-更改Mysql密码" class="headerlink" title="2.更改Mysql密码"></a>2.更改Mysql密码</h4><p><code>oneinstack</code>目录下，运行 <code>./reset_db_root_password.sh</code>，输入数据库密码。<br><img src="http://7xi72v.com1.z0.glb.clouddn.com/16-11-4/68090101.jpg" alt=""></p>
<h2 id="三、配置NodeJS"><a href="#三、配置NodeJS" class="headerlink" title="三、配置NodeJS"></a>三、配置NodeJS</h2><h4 id="1-yum更新"><a href="#1-yum更新" class="headerlink" title="1.yum更新"></a>1.yum更新</h4><p>主要的目的是为了当npm安装比较”娇气”的模块时不报错。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ yum -y update</span><br><span class="line">$ yum -y install zlib-devel curl-devel openssl-devel perl cpio expat-devel gettext-devel openssl zlib autoconf tk perl-ExtUtils-MakeMaker gcc make gcc-c++ openssl-devel wget</span><br></pre></td></tr></table></figure>
<p><img src="http://7xi72v.com1.z0.glb.clouddn.com/16-11-4/12134840.jpg" alt=""></p>
<h4 id="2-安装NodeJS"><a href="#2-安装NodeJS" class="headerlink" title="2.安装NodeJS"></a>2.安装<code>NodeJS</code></h4><p>这里采用<code>nvm</code>来安装<code>nodejs</code>，是因为<code>nvm</code>对<code>nodejs</code>进行版本管理，这就方便多了，比如我<code>Ghost</code>博客的<code>Node</code>版本只能是<code>0.10.x || 0.12.0</code>。而一般用的，是<code>4.x.x</code>了。所以非常有必要。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/creationix/nvm.git ~/.nvm</span><br><span class="line">$ <span class="built_in">source</span> ~/.nvm/nvm.sh</span><br><span class="line">$ vi ~/.bashrc 或者 ~/.profile 或者 ~/.zshrc`</span><br><span class="line">$ nvm install node版本号</span><br></pre></td></tr></table></figure>
<p>这样的话，下次ssh上去时，才不会发现<code>nvm</code>未安装。<br>参考<a href="https://github.com/creationix/nvm" target="_blank" rel="noopener">nvm的Usage</a></p>
<p><img src="http://7xi72v.com1.z0.glb.clouddn.com/16-11-5/30105026.jpg" alt=""></p>
<blockquote>
<p>安装完 node 后，安装一下 <a href="https://github.com/Pana/nrm" target="_blank" rel="noopener">nrm</a> ，用于更换 <code>npm</code> 源，加快模块安装速度。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// 安装nrm</span><br><span class="line">$ npm install -g nrm</span><br><span class="line">// 查看下有哪些好用的源</span><br><span class="line">$ nrm ls</span><br><span class="line">// 切换cnpm源</span><br><span class="line">$ nrm use cnpm</span><br></pre></td></tr></table></figure>
<h4 id="3-安装forever模块，永久运行node"><a href="#3-安装forever模块，永久运行node" class="headerlink" title="3.安装forever模块，永久运行node"></a>3.安装forever模块，永久运行node</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install -g forever</span><br></pre></td></tr></table></figure>
<p><img src="http://7xi72v.com1.z0.glb.clouddn.com/16-11-5/60815964.jpg" alt=""></p>
<h2 id="四、配置Ngnix"><a href="#四、配置Ngnix" class="headerlink" title="四、配置Ngnix"></a>四、配置Ngnix</h2><h4 id="1-虚拟主机的配置"><a href="#1-虚拟主机的配置" class="headerlink" title="1.虚拟主机的配置"></a>1.虚拟主机的配置</h4><p>新建后，会在产生2个重要文件(以我的域名test.ycjcl.cc为例)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">虚拟主机的配置文件(到时候运行nodejs时，需要更改成反向代理):             /usr/local/nginx/conf/vhost/test.ycjcl.cc.conf</span><br><span class="line">项目目录(node项目，可以通过ftp传上去):                 /data/wwwroot/test.ycjcl.cc</span><br></pre></td></tr></table></figure>
<p><img src="http://7xi72v.com1.z0.glb.clouddn.com/16-11-4/56277679.jpg" alt=""></p>
<h4 id="2-防火墙设置"><a href="#2-防火墙设置" class="headerlink" title="2.防火墙设置"></a>2.防火墙设置</h4><p>这里我生成了一个<code>express</code>项目，端口为3000，但是并不能访问到3000端口</p>
<p><img src="http://7xi72v.com1.z0.glb.clouddn.com/16-11-5/6929252.jpg" alt=""></p>
<p>需要防火墙忽略3000端口，所以执行以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 允许 3000 端口</span><br><span class="line">$ iptables -I INPUT 4 -p tcp -m state --state NEW -m tcp --dport 3000 -j ACCEPT</span><br><span class="line">// 保存 iptables 规则</span><br><span class="line">$ service iptables save</span><br></pre></td></tr></table></figure>
<p>就可以ip+端口访问了：</p>
<p><img src="http://7xi72v.com1.z0.glb.clouddn.com/16-11-5/9495109.jpg" alt=""></p>
<h4 id="3-将node服务和域名进行绑定"><a href="#3-将node服务和域名进行绑定" class="headerlink" title="3.将node服务和域名进行绑定"></a>3.将node服务和域名进行绑定</h4><p>修改配置：<strong>(中间的location都删了，直接加这个)</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vi /usr/<span class="built_in">local</span>/nginx/conf/vhost/test.ycjcl.cc.conf</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">location /</span><br><span class="line">&#123;</span><br><span class="line">    proxy_redirect off;</span><br><span class="line">    proxy_set_header   X-Real-IP            <span class="variable">$remote_addr</span>;</span><br><span class="line">    proxy_set_header   X-Forwarded-For  <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">    proxy_set_header   Host                   <span class="variable">$http_host</span>;</span><br><span class="line">    proxy_set_header   X-NginX-Proxy    <span class="literal">true</span>;</span><br><span class="line">    proxy_set_header   Connection <span class="string">""</span>;</span><br><span class="line">    proxy_http_version 1.1;</span><br><span class="line">    proxy_pass        http://127.0.0.1:3000;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后重启nginx ,<code>service nginx restart</code></p>
<p>然后用域名访问成功，！！！</p>
<p><img src="http://7xi72v.com1.z0.glb.clouddn.com/16-11-5/58499048.jpg" alt=""></p>
<p>需要 phpMyAdmin,直接用 <code>ip/phpMyAdmin</code>，可以进行mysql的管理。</p>
<h2 id="五、安装Mongodb-可选"><a href="#五、安装Mongodb-可选" class="headerlink" title="五、安装Mongodb(可选)"></a>五、安装Mongodb(可选)</h2><h4 id="1-首先将mongodb源添加到yum中。vim-etc-yum-repos-d-mongodb-repo编辑添加以下内容："><a href="#1-首先将mongodb源添加到yum中。vim-etc-yum-repos-d-mongodb-repo编辑添加以下内容：" class="headerlink" title="1.首先将mongodb源添加到yum中。vim /etc/yum.repos.d/mongodb.repo编辑添加以下内容："></a>1.首先将mongodb源添加到yum中。<code>vim /etc/yum.repos.d/mongodb.repo</code>编辑添加以下内容：</h4><p><strong>如果是64位CentOS 7系统</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[mongodb]</span><br><span class="line">name=MongoDB Repository</span><br><span class="line">baseurl=http://downloads-distro.mongodb.org/repo/redhat/os/x86_64/</span><br><span class="line">gpgcheck=0</span><br><span class="line">enabled=1</span><br></pre></td></tr></table></figure>
<p><img src="http://7xi72v.com1.z0.glb.clouddn.com/16-8-31/76029784.jpg" alt=""></p>
<p><strong>如果是32位系统</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[mongodb]</span><br><span class="line">name=MongoDB Repository</span><br><span class="line">baseurl=http://downloads-distro.mongodb.org/repo/redhat/os/i686/</span><br><span class="line">gpgcheck=0</span><br><span class="line">enabled=1</span><br></pre></td></tr></table></figure>
<h6 id="2-先更新yum，然后安装mongodb"><a href="#2-先更新yum，然后安装mongodb" class="headerlink" title="2.先更新yum，然后安装mongodb"></a>2.先更新yum，然后安装mongodb</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 更新</span><br><span class="line">$ yum -y update</span><br><span class="line">// 安装mongodb</span><br><span class="line">$ yum -y install mongodb-org mongodb-org-server</span><br></pre></td></tr></table></figure>
<h6 id="3-运行mongodb-默认27017端口"><a href="#3-运行mongodb-默认27017端口" class="headerlink" title="3.运行mongodb(默认27017端口)"></a>3.运行mongodb(默认27017端口)</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl &#123;start|status|stop&#125; mongod</span><br></pre></td></tr></table></figure>
<p><img src="http://7xi72v.com1.z0.glb.clouddn.com/16-8-31/35405771.jpg" alt=""></p>
<blockquote>
<p>注意：从MongoDB“赎金事件”中，建议一定要使用<code>db.addUser</code>和<code>db.changeUserPassword</code>更改用户名和密码。</p>
</blockquote>
<h2 id="六、常见问题"><a href="#六、常见问题" class="headerlink" title="六、常见问题"></a>六、常见问题</h2><blockquote>
<p>如果重装系统，ssh上去时，出现以下错误，用<code>ssh-keygen -R IP地址</code> 来解决</p>
</blockquote>
<p><img src="http://7xi72v.com1.z0.glb.clouddn.com/16-7-22/68866015.jpg" alt=""></p>
<blockquote>
<p>有时候开启node服务时，提示某个端口被占用。此时要用命令查看端口<code>fuser -n tcp 端口号</code>，或查看服务<code>ps -ef | grep 服务名</code>，kill掉<code>kill -9 pID进程号</code>。如果大型访问量时，优雅软重启的使用<code>kill -HUP pID进程号</code>。</p>
</blockquote>
<p><img src="http://7xi72v.com1.z0.glb.clouddn.com/17-2-15/83014875-file_1487151517505_2138.png" alt=""></p>
</div></article></div></main><footer><div class="paginator"><a href="/2018/07/08/全国高校网安联赛Web专场~WriteUp/" class="prev">上一篇</a><a href="/2018/07/08/2016第二届陕西省网络空间安全大赛WriteUp/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2018 <a href="https://www.ycjcl.cc">Kylin King</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>