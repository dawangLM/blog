<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 前后分离之"电影投票系统" · 信鑫-King's Blog</title><meta name="description" content="前后分离之&quot;电影投票系统&quot; - Kylin King"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://www.ycjcl.cc/atom.xml" title="信鑫-King's Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/ycjcl868" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/ycjcl868" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">前后分离之"电影投票系统"</h1><div class="post-info">Jul 8, 2018</div><div class="post-content"><h1 id="电影投票系统"><a href="#电影投票系统" class="headerlink" title="电影投票系统"></a>电影投票系统</h1><blockquote>
<p>Java课程设计，想试试前后端完全分离的开发(原来在Class+时曾体验过)，于是有了下面4天2人的开发历程。先上图吧！Github地址：<a href="https://github.com/ycjcl868/VoteApp" target="_blank" rel="noopener">https://github.com/ycjcl868/VoteApp</a>，Demo：<a href="http://movie.ycjcl.cc" target="_blank" rel="noopener">http://movie.ycjcl.cc</a></p>
</blockquote>
<p>前台投票页：</p>
<ul>
<li style="list-style: none"><input type="checkbox" checked> 查看电影列表</li>
<li style="list-style: none"><input type="checkbox" checked> 执行投票操作</li>
<li style="list-style: none"><input type="checkbox" checked> 查看一小时内的日志及日志数</li>
<li style="list-style: none"><input type="checkbox" checked> 数据统计图</li>
<li style="list-style: none"><input type="checkbox"> 搜索</li>
<li style="list-style: none"><input type="checkbox"> 投票成功分享</li>
</ul>
<p><img src="http://7xi72v.com1.z0.glb.clouddn.com/1.gif" alt=""></p>
<p>后台管理：</p>
<ul>
<li style="list-style: none"><input type="checkbox" checked> 新增电影</li>
<li style="list-style: none"><input type="checkbox" checked> 删除电影</li>
<li style="list-style: none"><input type="checkbox" checked> 查看日志</li>
<li style="list-style: none"><input type="checkbox"> 修改电影</li>
<li style="list-style: none"><input type="checkbox"> 查看统计图</li>
</ul>
<p><img src="http://7xi72v.com1.z0.glb.clouddn.com/2.gif" alt=""></p>
<h2 id="系统架构"><a href="#系统架构" class="headerlink" title="系统架构"></a>系统架构</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>共用了两台腾讯云服务器(CentOS 7)，一台前端Node服务器和一台Java SpringMVC服务器，之前的交互通过<code>JSON</code>。通过前后分离，将<code>MVC</code>中的<code>View</code>和<code>Controller</code>层分给前端，后台<code>SpringMVC</code>负责<code>Model</code>层，只提供<code>JSON</code>数据，交互如图：</p>
<p><img src="http://7xi72v.com1.z0.glb.clouddn.com/架构图.png" alt=""></p>
<blockquote>
<p>看到这个架构，想起原来大一在Class+的困惑，问了孵化器里的很多人，都不能解决我的问题。我的问题是这样的，Class+的App和后台(也是Spring，JSON接口)是写好的，当时只会<strong>PHP</strong>且<strong>Node</strong>没这么流行。然后要做一个网站，接口要调用<strong>Spring</strong>写好的，然后把整个前端静态页面管理组织起来。当时的<strong>PHP</strong>就相当于现在的<strong>Node</strong>，只不过那时候的纯<strong>PHP</strong>发<strong>POST</strong>请求时真是麻烦(调用<strong>CURL</strong>一堆方法)。且那时候傻到直接将<strong>Java</strong>后台地址调到<strong>$.ajax(url)</strong>里，导致跨域问题，用<strong>JSONP</strong>，还让写后台<strong>Spring</strong>的越越修改<strong>Access-Control</strong>头，且返回的<strong>JSON</strong>数据有时还需要用<strong>‘(‘+eval(str)+’)’去处理一下</strong>。现在好了，直接<strong>Node</strong>前后一体化<strong>JS</strong>代码解决疑惑。</p>
</blockquote>
<h3 id="前端服务器"><a href="#前端服务器" class="headerlink" title="前端服务器"></a>前端服务器</h3><p>前端在数据层采用<code>Express</code>+<code>Vue</code>，UI 层前台使用腾讯手 Q的<a href="http://frozenui.github.io" target="_blank" rel="noopener">Frozenui</a>  + <a href="http://zeptojs.com" target="_blank" rel="noopener">Zepto</a> + <a href="http://layer.layui.com/mobile/" target="_blank" rel="noopener">LayerMobile</a> + <a href="http://canvasjs.com" target="_blank" rel="noopener">CanvasJS(这个我极力推荐,个人贡献了中文文档)</a>，后台管理使用<code>老油条组合</code> <a href="">jQuery</a> + <a href="http://v3.bootcss.com" target="_blank" rel="noopener">BootStrap</a> 。 整个前端使用<code>Gulp</code>进行自动化处理，配置见<a href="https://www.ycjcl.cc/2017/01/08/express-gulppei-zhi-gao-xiao-lu-kai-fa-huan-jing/">Express+Gulp配置高效率开发环境</a>。</p>
<h4 id="首页："><a href="#首页：" class="headerlink" title="首页："></a>首页：</h4><p><img src="http://7xi72v.com1.z0.glb.clouddn.com/3.jpg" alt=""></p>
<p><img src="http://7xi72v.com1.z0.glb.clouddn.com/1.png" alt=""></p>
<h4 id="日志页："><a href="#日志页：" class="headerlink" title="日志页："></a>日志页：</h4><p><img src="http://7xi72v.com1.z0.glb.clouddn.com/2.png" alt=""></p>
<h4 id="数据统计页："><a href="#数据统计页：" class="headerlink" title="数据统计页："></a>数据统计页：</h4><p><img src="http://7xi72v.com1.z0.glb.clouddn.com/0.png" alt=""></p>
<h4 id="后台页面"><a href="#后台页面" class="headerlink" title="后台页面"></a>后台页面</h4><p><img src="http://7xi72v.com1.z0.glb.clouddn.com/5.png" alt=""></p>
<p><img src="http://7xi72v.com1.z0.glb.clouddn.com/10.png" alt=""></p>
<h4 id="信息安全"><a href="#信息安全" class="headerlink" title="信息安全"></a>信息安全</h4><p>对传输数据进行了加密处理：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 执行投票操作(POST)</span></span><br><span class="line"><span class="comment"> * @param userIP 用户ip</span></span><br><span class="line"><span class="comment"> * @param token  用户唯一标识加密(ip+'xxxx').md5()</span></span><br><span class="line"><span class="comment"> * @param cineId 电影id</span></span><br><span class="line"><span class="comment"> * @param province  省份</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 返回：state // 状态或票数</span></span><br><span class="line"><span class="comment"> *      cineId // 电影id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">router.post(<span class="string">'/doVote'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> params = &#123;&#125;;</span><br><span class="line">    <span class="keyword">var</span> send = res;</span><br><span class="line">    params.userIP = req.session.ip;</span><br><span class="line">    params.token = api.cryptoToken(req.session.ip);</span><br><span class="line">    params.cineId = req.body.cineId;</span><br><span class="line">    <span class="comment">// 通过百度接口用 ip 获得省份</span></span><br><span class="line">    api.getProvince(req.session.ip,<span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">        params.province = res;</span><br><span class="line">        <span class="built_in">console</span>.log(params);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 执行投票操作</span></span><br><span class="line">        api.doVote(params,<span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(res);</span><br><span class="line">            send.send(res);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>然后后台Java拿到<code>ip</code>后，对<code>ip</code>进行加密然后判断是否等于前端传来的<code>token</code>来执行投票操作。</p>
<p><img src="http://7xi72v.com1.z0.glb.clouddn.com/11.png" alt=""></p>
<h4 id="本地存储"><a href="#本地存储" class="headerlink" title="本地存储"></a>本地存储</h4><p>首次在项目中使用<code>localStorage</code>的新特性，存储了是否投过票<code>voteId</code>和投票时间<code>voteTime</code>。来前端控制一个小时内只能投票一次(当然后台 Java 也得控制呢~)。当<code>Vue</code>到<code>ready</code>生命周期时就判断：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> currentTime = <span class="keyword">new</span> <span class="built_in">Date</span>().getTime();</span><br><span class="line"><span class="keyword">var</span> voteTime = localStorage.getItem(<span class="string">'voteTime'</span>);</span><br><span class="line"><span class="comment">// console.log('currentTime'+currentTime);</span></span><br><span class="line"><span class="comment">// console.log('voteTime'+voteTime);</span></span><br><span class="line"><span class="comment">// console.log(currentTime - voteTime &gt;= 3600000);</span></span><br><span class="line"><span class="keyword">if</span>(currentTime - voteTime &gt;= <span class="number">3600000</span>)&#123;</span><br><span class="line">	<span class="comment">// 一个小时后，就可以投票了(实际上是可以向 Java 发请求了)</span></span><br><span class="line">	localStorage.setItem(<span class="string">'voteId'</span>,<span class="string">'-1'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样，再次刷新时，如果投过<code>button</code>就成灰色，效果如图</p>
<p><img src="http://7xi72v.com1.z0.glb.clouddn.com/8.png" alt=""></p>
<p>当然，另一舍友今天也问我，为什么不用<code>cookie</code>，<code>cookie</code>还可以设置过期时间呢，区别是什么?，见文解析<a href="http://jerryzou.com/posts/cookie-and-web-storage/" target="_blank" rel="noopener">详说 Cookie, LocalStorage 与 SessionStorage</a>。不过，我认为<code>cookie</code>也是可以的，<code>localStorage</code>是键值对，而<code>cookie</code>只是字符串，没有封装<code>cookie</code>方法时操作<code>cookie</code>就比较麻烦。</p>
<h4 id="前端自动化工具Gulp"><a href="#前端自动化工具Gulp" class="headerlink" title="前端自动化工具Gulp"></a>前端自动化工具Gulp</h4><p>本想试下<code>Webpack</code>，发现不好配，还是配下稍微熟悉点的<code>Gulp</code>，发现真是方便，自动编译<code>Less</code>，自动检查语法错误，自动压缩，自动浏览器刷新，前端开发神器。</p>
<p><img src="http://7xi72v.com1.z0.glb.clouddn.com/13.png" alt=""></p>
<h4 id="NodeJS图片异步上传"><a href="#NodeJS图片异步上传" class="headerlink" title="NodeJS图片异步上传"></a>NodeJS图片异步上传</h4><p>这一块原来用<code>Express</code>框架一直没上传过，这次看了<code>multer</code>官方原版文档 + 原来前端原生JS使用的<code>Formdata</code>对象，完美实现异步上传预览。 <strong>下次发博时写个详细的解决Express异步上传图片预览</strong>(因为现在用国内搜索引擎搜出来的基本都用不了，不是让你用jquery插件，就是让你npm install xxx模块，都不能很好的解决。)</p>
<h3 id="后台服务器"><a href="#后台服务器" class="headerlink" title="后台服务器"></a>后台服务器</h3><p>只负责提供<code>JSON</code>数据，基本架构<code>Springmvc+Spring+MyBatis</code>是我舍友写的。数据库采用 <code>Mysql</code>(本来打算用<code>Oracle</code>，不过实在是太重了，不易管理，所以换Mysql了)</p>
<p><img src="http://7xi72v.com1.z0.glb.clouddn.com/7.png" alt=""></p>
<h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><h6 id="1-首次和舍友采用前后分离的架构，没有文档驱动，接口就基本上通过-QQ-沟通。因为接口较少。"><a href="#1-首次和舍友采用前后分离的架构，没有文档驱动，接口就基本上通过-QQ-沟通。因为接口较少。" class="headerlink" title="1. 首次和舍友采用前后分离的架构，没有文档驱动，接口就基本上通过 QQ 沟通。因为接口较少。"></a>1. 首次和舍友采用<strong>前后分离</strong>的架构，没有文档驱动，接口就基本上通过 QQ 沟通。因为接口较少。</h6><h6 id="2-后台英文要稍微好点，不然-“statue”-1-和-“status”-1-是很容易写错了。-自我反省了好久，我有没有错，才发现不是我的错。"><a href="#2-后台英文要稍微好点，不然-“statue”-1-和-“status”-1-是很容易写错了。-自我反省了好久，我有没有错，才发现不是我的错。" class="headerlink" title="2. 后台英文要稍微好点，不然{“statue”:1}和{“status”:1}是很容易写错了。(自我反省了好久，我有没有错，才发现不是我的错。)"></a>2. 后台英文要稍微好点，不然<strong>{“statue”:1}</strong>和<strong>{“status”:1}</strong>是很容易写错了。(自我反省了好久，我有没有错，才发现不是我的错。)</h6><p><img src="http://7xi72v.com1.z0.glb.clouddn.com/12.png" alt=""></p>
<p><img src="http://7xi72v.com1.z0.glb.clouddn.com/9.png" alt=""></p>
<h6 id="3-json问题，有时一粗心，就忘通过JSON-parse-jsonStr-将json字符串转成json对象了。"><a href="#3-json问题，有时一粗心，就忘通过JSON-parse-jsonStr-将json字符串转成json对象了。" class="headerlink" title="3. json问题，有时一粗心，就忘通过JSON.parse(jsonStr)将json字符串转成json对象了。"></a>3. <strong>json</strong>问题，有时一粗心，就忘通过<strong>JSON.parse(jsonStr)</strong>将<strong>json字符串</strong>转成<strong>json对象</strong>了。</h6><h6 id="4-前端完全分离的调试问题，舍友的电脑能连的Wifi我连不上，我能连的他连不上。然后就买了腾讯云的CentOS-7-Java服务器。"><a href="#4-前端完全分离的调试问题，舍友的电脑能连的Wifi我连不上，我能连的他连不上。然后就买了腾讯云的CentOS-7-Java服务器。" class="headerlink" title="4. 前端完全分离的调试问题，舍友的电脑能连的Wifi我连不上，我能连的他连不上。然后就买了腾讯云的CentOS 7 Java服务器。"></a>4. 前端完全分离的调试问题，舍友的电脑能连的Wifi我连不上，我能连的他连不上。然后就买了腾讯云的<code>CentOS 7</code> Java服务器。</h6><h6 id="5-舍友对Linux不是太了解，在大小写方面和目录权限问题上没处理好！"><a href="#5-舍友对Linux不是太了解，在大小写方面和目录权限问题上没处理好！" class="headerlink" title="5. 舍友对Linux不是太了解，在大小写方面和目录权限问题上没处理好！"></a>5. 舍友对<strong>Linux</strong>不是太了解，在<strong>大小写方面</strong>和<strong>目录权限</strong>问题上没处理好！</h6><p><img src="http://7xi72v.com1.z0.glb.clouddn.com/14.png" alt=""></p>
<h6 id="6-后台对编码的处理没统一，先传过去的中文全是乱码，我一看数据库格式不是utf8-general-ci就明白了，结果还是乱码，舍友一看肯定是SpringMVC没有设置过滤器UTF-8格式，一加就OK了"><a href="#6-后台对编码的处理没统一，先传过去的中文全是乱码，我一看数据库格式不是utf8-general-ci就明白了，结果还是乱码，舍友一看肯定是SpringMVC没有设置过滤器UTF-8格式，一加就OK了" class="headerlink" title="6. 后台对编码的处理没统一，先传过去的中文全是乱码，我一看数据库格式不是utf8_general_ci就明白了，结果还是乱码，舍友一看肯定是SpringMVC没有设置过滤器UTF-8格式，一加就OK了"></a>6. 后台对编码的处理没统一，先传过去的中文全是乱码，我一看数据库格式不是<strong>utf8_general_ci</strong>就明白了，结果还是乱码，舍友一看肯定是<strong>SpringMVC</strong>没有设置过滤器<strong>UTF-8</strong>格式，一加就<strong>OK</strong>了</h6><h6 id="7-部署在云上时才发现的，因为用了Nginx服务器代理到了NodeJS，所以才开始获取到的用户ip全是127-0-0-1，最后Node要获取ip的话，只能通过X-Forwarded-For-的头-起初我个人觉得不太安全，不过一测试，结果不能伪造-。"><a href="#7-部署在云上时才发现的，因为用了Nginx服务器代理到了NodeJS，所以才开始获取到的用户ip全是127-0-0-1，最后Node要获取ip的话，只能通过X-Forwarded-For-的头-起初我个人觉得不太安全，不过一测试，结果不能伪造-。" class="headerlink" title="7. 部署在云上时才发现的，因为用了Nginx服务器代理到了NodeJS，所以才开始获取到的用户ip全是127.0.0.1，最后Node要获取ip的话，只能通过X-Forwarded-For 的头(起初我个人觉得不太安全，不过一测试，结果不能伪造)。"></a>7. 部署在云上时才发现的，因为用了<strong>Nginx</strong>服务器代理到了<strong>NodeJS</strong>，所以才开始获取到的用户ip全是<code>127.0.0.1</code>，最后<strong>Node</strong>要获取<code>ip</code>的话，只能通过<code>X-Forwarded-For</code> 的头<code>(起初我个人觉得不太安全，不过一测试，结果不能伪造)</code>。</h6><p><img src="http://7xi72v.com1.z0.glb.clouddn.com/FFA456B0-26BE-45A6-A0B9-D8627275D7CA.png" alt=""></p>
<h6 id="8-正式投票时，发现投了6个左右，后台Java-Spring后台就挂掉了，显示的错误信息大概的意思是阻止请求信息，一查发现是没有配置连接数，所以就爆掉了，临时写了一个反馈的弹窗。最后改了之后，就能解决小量高并发了。"><a href="#8-正式投票时，发现投了6个左右，后台Java-Spring后台就挂掉了，显示的错误信息大概的意思是阻止请求信息，一查发现是没有配置连接数，所以就爆掉了，临时写了一个反馈的弹窗。最后改了之后，就能解决小量高并发了。" class="headerlink" title="8. 正式投票时，发现投了6个左右，后台Java Spring后台就挂掉了，显示的错误信息大概的意思是阻止请求信息，一查发现是没有配置连接数，所以就爆掉了，临时写了一个反馈的弹窗。最后改了之后，就能解决小量高并发了。"></a>8. 正式投票时，发现投了6个左右，后台<strong>Java Spring</strong>后台就挂掉了，显示的错误信息大概的意思是<strong>阻止请求信息</strong>，一查发现是没有配置连接数，所以就爆掉了，临时写了一个反馈的弹窗。最后改了之后，就能解决小量高并发了。</h6><p><img src="http://7xi72v.com1.z0.glb.clouddn.com/D9AEEFE8-17CB-474A-829A-AD06D14B9424.png" alt=""></p>
</div></article></div></main><footer><div class="paginator"><a href="/2018/07/08/算法练习(Java)/" class="prev">PREV</a><a href="/2018/07/08/2016中国·西安“华山杯”WriteUp- SeeSea/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2018 <a href="https://www.ycjcl.cc">Kylin King</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>